<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <view class="page-title">åˆ›å»ºè®¢å•</view>
    <view class="page-desc">ä¸ºå®¢æˆ·åˆ›å»ºæ–°è®¢å•</view>
  </view>

  <!-- é€‰æ‹©é—¨åº— -->
  <view class="form-section">
    <view class="section-title">é€‰æ‹©é—¨åº—</view>
    <view class="store-selector" bindtap="selectStore">
      <view class="store-info" wx:if="{{selectedStore}}">
        <view class="store-name">{{selectedStore.storeName}}</view>
        <view class="store-contact">{{selectedStore.owner.name}} - {{selectedStore.owner.phone}}</view>
        <view class="store-address">{{selectedStore.address.street}}</view>
      </view>
      <view class="store-placeholder" wx:else>
        <text class="placeholder-text">ç‚¹å‡»é€‰æ‹©é—¨åº—</text>
        <text class="placeholder-icon">></text>
      </view>
    </view>
  </view>

  <!-- å•†å“åˆ—è¡¨ -->
  <view class="form-section">
    <view class="section-title">
      <text>é€‰æ‹©å•†å“</text>
      <button class="add-product-btn" bindtap="addProduct">æ·»åŠ å•†å“</button>
    </view>
    
    <view class="product-list" wx:if="{{orderItems.length > 0}}">
      <view class="product-item" wx:for="{{orderItems}}" wx:key="id" wx:for-item="item">
        <view class="product-info">
          <image class="product-image" src="{{item.product.images[0] || '/assets/images/default-product.png'}}" mode="aspectFill" />
          <view class="product-details">
            <view class="product-name">{{item.product.productName}}</view>
            <view class="product-code">{{item.product.productCode}}</view>
            <view class="product-price">ï¿¥{{item.unitPrice}}/{{item.product.unit}}</view>
            <view class="product-stock">åº“å­˜ï¼š{{item.product.inventory.availableStock}}</view>
          </view>
        </view>
        
        <view class="quantity-controls">
          <view class="quantity-label">æ•°é‡</view>
          <view class="quantity-selector">
            <button class="quantity-btn" bindtap="changeQuantity" data-index="{{index}}" data-action="minus">-</button>
            <input 
              class="quantity-input" 
              type="number" 
              value="{{item.quantity}}" 
              bindinput="onQuantityInput"
              data-index="{{index}}"
            />
            <button class="quantity-btn" bindtap="changeQuantity" data-index="{{index}}" data-action="plus">+</button>
          </view>
        </view>
        
        <view class="item-actions">
          <view class="item-total">å°è®¡ï¼šï¿¥{{item.totalPrice}}</view>
          <button class="remove-btn" bindtap="removeItem" data-index="{{index}}">ç§»é™¤</button>
        </view>
      </view>
    </view>
    
    <view class="empty-products" wx:else>
      <view class="empty-icon">ğŸ“¦</view>
      <view class="empty-text">è¿˜æ²¡æœ‰é€‰æ‹©å•†å“</view>
      <button class="add-first-product" bindtap="addProduct">é€‰æ‹©å•†å“</button>
    </view>
  </view>

  <!-- è®¢å•ä¿¡æ¯ -->
  <view class="form-section" wx:if="{{orderItems.length > 0}}">
    <view class="section-title">è®¢å•ä¿¡æ¯</view>
    
    <view class="form-item">
      <view class="form-label">è®¢å•ç±»å‹</view>
      <picker bindchange="onOrderTypeChange" value="{{orderTypeIndex}}" range="{{orderTypes}}">
        <view class="picker">
          {{orderTypes[orderTypeIndex] || 'è¯·é€‰æ‹©è®¢å•ç±»å‹'}}
        </view>
      </picker>
    </view>

    <view class="form-item">
      <view class="form-label">æ”¯ä»˜æ–¹å¼</view>
      <picker bindchange="onPaymentMethodChange" value="{{paymentMethodIndex}}" range="{{paymentMethods}}">
        <view class="picker">
          {{paymentMethods[paymentMethodIndex] || 'è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼'}}
        </view>
      </picker>
    </view>

    <view class="form-item">
      <view class="form-label">é…é€æ–¹å¼</view>
      <picker bindchange="onDeliveryMethodChange" value="{{deliveryMethodIndex}}" range="{{deliveryMethods}}">
        <view class="picker">
          {{deliveryMethods[deliveryMethodIndex] || 'è¯·é€‰æ‹©é…é€æ–¹å¼'}}
        </view>
      </picker>
    </view>

    <view class="form-item" wx:if="{{formData.deliveryMethod === 'é€è´§ä¸Šé—¨'}}">
      <view class="form-label">é…é€åœ°å€</view>
      <textarea 
        class="form-textarea" 
        placeholder="è¯·è¾“å…¥é…é€åœ°å€" 
        value="{{formData.deliveryAddress}}" 
        bindinput="onDeliveryAddressInput"
        maxlength="200"
      />
    </view>

    <view class="form-item">
      <view class="form-label">é¢„è®¡é…é€æ—¶é—´</view>
      <picker 
        mode="date" 
        start="{{todayDate}}"
        bindchange="onDeliveryDateChange" 
        value="{{formData.plannedDeliveryDate}}"
      >
        <view class="picker">
          {{formData.plannedDeliveryDate || 'è¯·é€‰æ‹©é…é€æ—¶é—´'}}
        </view>
      </picker>
    </view>

    <view class="form-item" wx:if="{{formData.paymentMethod === 'èµŠè´¦'}}">
      <view class="form-label">è´¦æœŸå¤©æ•°</view>
      <input 
        class="form-input" 
        type="number" 
        placeholder="è¯·è¾“å…¥è´¦æœŸå¤©æ•°" 
        value="{{formData.creditDays}}" 
        bindinput="onCreditDaysInput"
      />
    </view>

    <view class="form-item">
      <view class="form-label">å¤‡æ³¨</view>
      <textarea 
        class="form-textarea" 
        placeholder="è¯·è¾“å…¥è®¢å•å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰" 
        value="{{formData.notes}}" 
        bindinput="onNotesInput"
        maxlength="500"
      />
    </view>
  </view>

  <!-- è®¢å•æ±‡æ€» -->
  <view class="order-summary" wx:if="{{orderItems.length > 0}}">
    <view class="summary-title">è®¢å•æ±‡æ€»</view>
    <view class="summary-row">
      <text class="label">å•†å“æ•°é‡</text>
      <text class="value">{{totalQuantity}}ä»¶</text>
    </view>
    <view class="summary-row">
      <text class="label">å•†å“å°è®¡</text>
      <text class="value">ï¿¥{{subtotal}}</text>
    </view>
    <view class="summary-row">
      <text class="label">é…é€è´¹ç”¨</text>
      <text class="value">ï¿¥{{deliveryFee}}</text>
    </view>
    <view class="summary-row total">
      <text class="label">è®¢å•æ€»é¢</text>
      <text class="value">ï¿¥{{totalAmount}}</text>
    </view>
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view class="submit-section">
    <button 
      class="submit-btn {{canSubmit ? '' : 'disabled'}}" 
      bindtap="submitOrder"
      disabled="{{!canSubmit || submitting}}"
    >
      {{submitting ? 'æäº¤ä¸­...' : 'åˆ›å»ºè®¢å•'}}
    </button>
  </view>
</view>

<!-- é—¨åº—é€‰æ‹©å¼¹çª— -->
<view class="modal" wx:if="{{showStoreModal}}" bindtap="hideStoreModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©é—¨åº—</text>
      <button class="modal-close" bindtap="hideStoreModal">Ã—</button>
    </view>
    <view class="store-list">
      <view 
        class="modal-store-item {{item._id === selectedStore?._id ? 'selected' : ''}}" 
        wx:for="{{storeList}}" 
        wx:key="_id"
        bindtap="selectStoreFromModal"
        data-store="{{item}}"
      >
        <view class="store-name">{{item.storeName}}</view>
        <view class="store-contact">{{item.owner.name}} - {{item.owner.phone}}</view>
        <view class="store-address">{{item.address.street}}</view>
      </view>
    </view>
  </view>
</view>

<!-- å•†å“é€‰æ‹©å¼¹çª— -->
<view class="modal" wx:if="{{showProductModal}}" bindtap="hideProductModal">
  <view class="modal-content product-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©å•†å“</text>
      <button class="modal-close" bindtap="hideProductModal">Ã—</button>
    </view>
    
    <view class="product-search">
      <input 
        class="search-input" 
        placeholder="æœç´¢å•†å“åç§°" 
        value="{{productSearchText}}" 
        bindinput="onProductSearchInput"
      />
    </view>
    
    <view class="product-modal-list">
      <view 
        class="modal-product-item" 
        wx:for="{{productList}}" 
        wx:key="_id"
        bindtap="selectProductFromModal"
        data-product="{{item}}"
      >
        <image class="product-image" src="{{item.images[0] || '/assets/images/default-product.png'}}" mode="aspectFill" />
        <view class="product-info">
          <view class="product-name">{{item.productName}}</view>
          <view class="product-code">{{item.productCode}}</view>
          <view class="product-price">ï¿¥{{item.pricing.wholesalePrice}}/{{item.unit}}</view>
          <view class="product-stock">åº“å­˜ï¼š{{item.inventory.availableStock}}</view>
        </view>
      </view>
    </view>
  </view>
</view>